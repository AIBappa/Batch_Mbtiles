---
- hosts: localhost
  become: true
  vars:
    docker_image_name: india-tiles-converter
    pbf_dir: /root/geo2day_india
    shortbread_dir: /root/geo2day_mbtiles_india_shortbread
    openmaptiles_dir: /root/geo2day_mbtiles_india_openmaptiles
    routing_dir: /root/geo2day_routing_india
    build_dir: /root/ansible_india

  tasks:
    - name: Ensure python3-pip is present
      apt:
        name: python3-pip
        state: present

    - name: Ensure python3-docker is installed (Debian/Ubuntu)
      apt:
        name: python3-docker
        state: present
        update_cache: true

    - name: Ensure Ansible Docker collection is present
      ansible.builtin.shell: ansible-galaxy collection install community.docker
      args:
        creates: /root/.ansible/collections/ansible_collections/community/docker

    - name: Ensure output directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - "{{ shortbread_dir }}"
        - "{{ openmaptiles_dir }}"
        - "{{ routing_dir }}"

    - name: Write Dockerfile
      copy:
        dest: "{{ build_dir }}/Dockerfile"
        content: |
          FROM --platform=linux/arm64 ubuntu:22.04
          ENV DEBIAN_FRONTEND=noninteractive

          # ------------------------------------------------------------------
          # 1.  every -dev header tilemaker & valhalla can reference
          # ------------------------------------------------------------------
          RUN apt-get update && \
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              # compilers / essential toolchain
              build-essential ca-certificates git cmake make pkg-config \
              # boost (complete â€“ pulls every header tilemaker may touch)
              libboost-all-dev \
              # protocol-buffer
              libprotobuf-dev protobuf-compiler libprotobuf-lite23 \
              # compression
              zlib1g-dev liblz4-dev libdeflate-dev \
              # http / curl
              libcurl4-openssl-dev \
              # scripting
              lua5.3 liblua5.3-dev \
              # geometry & projections
              libgeos-dev libproj-dev proj-data \
              # sqlite / spatialite
              libsqlite3-dev libspatialite-dev \
              # shapelib (shapefil.h)
              libshp-dev \
              # json
              rapidjson-dev \
              # tiff / jpeg (valhalla uses them for elevation/landcover)
              libtiff-dev libjpeg-dev libjpeg-turbo8-dev \
              # xml (valhalla reads lua profiles that parse XML)
              libxml2-dev \
              # python headers (valhalla python bindings, optional but harmless)
              python3-dev python3-pip \
              # a few run-time helpers that --no-install-recommends would drop
              unzip wget curl \
              # tidy up
              && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

          # ------------------------------------------------------------------
          # 2.  tilemaker
          # ------------------------------------------------------------------
          RUN git clone --depth 1 https://github.com/systemed/tilemaker.git /tilemaker \
              && cd /tilemaker \
              && make -j$(nproc) \
              && cp tilemaker /usr/local/bin/

          # ------------------------------------------------------------------
          # 3.  valhalla
          # ------------------------------------------------------------------
          RUN git clone --recurse-submodules https://github.com/valhalla/valhalla.git /valhalla \
              && cd /valhalla \
              && mkdir build && cd build \
              && cmake .. -DCMAKE_BUILD_TYPE=Release \
                          -DENABLE_SERVICES=OFF \
                          -DENABLE_LUAJIT=OFF \
              && make -j$(nproc) && make install \
              && ldconfig

          # ------------------------------------------------------------------
          # 4.  config files
          # ------------------------------------------------------------------
          WORKDIR /configs
          RUN wget -q https://raw.githubusercontent.com/systemed/tilemaker/master/resources/config-openmaptiles.json \
              && wget -q https://raw.githubusercontent.com/systemed/tilemaker/master/resources/process-openmaptiles.lua \
              && wget -q https://raw.githubusercontent.com/shortbread-tiles/shortbread-tilemaker/master/config.json -O config-shortbread.json \
              && wget -q https://raw.githubusercontent.com/shortbread-tiles/shortbread-tilemaker/master/process.lua -O process-shortbread.lua

          # ------------------------------------------------------------------
          # 5.  helper script
          # ------------------------------------------------------------------
          WORKDIR /work
          COPY convert_all.sh /work/
          RUN chmod +x /work/convert_all.sh

          CMD ["/work/convert_all.sh"]

    - name: Write batch conversion shell script
      copy:
        dest: "{{ build_dir }}/convert_all.sh"
        mode: "0755"
        content: |
          #!/bin/bash
          set -e
          PBF_DIR="/pbf"
          SHORTBREAD_OUT="/mbtiles_shortbread"
          OPENMAPTILES_OUT="/mbtiles_openmaptiles"
          VALHALLA_OUT="/routing"
          mkdir -p "$SHORTBREAD_OUT" "$OPENMAPTILES_OUT" "$VALHALLA_OUT"
          for PBF in "$PBF_DIR"/*.pbf; do
            BASENAME=$(basename "$PBF" .pbf)
            echo "Processing $BASENAME"
            tilemaker --input "$PBF" --output "$SHORTBREAD_OUT/$BASENAME.mbtiles" --config /configs/config-shortbread.json --process /configs/process-shortbread.lua
            tilemaker --input "$PBF" --output "$OPENMAPTILES_OUT/$BASENAME.mbtiles" --config /configs/config-openmaptiles.json --process /configs/process-openmaptiles.lua
            VAL_DIR="$VALHALLA_OUT/${BASENAME}_tiles"
            mkdir -p "$VAL_DIR"
            cat > "/tmp/valhalla_$BASENAME.json" <<EOF
          {
            "mjolnir": {
              "tile_dir": "$VAL_DIR",
              "admin": "",
              "timezone": "",
              "concurrency": 4,
              "logging": { "type": "std_out", "color": true }
            }
          }
          EOF
            valhalla_build_tiles --config "/tmp/valhalla_$BASENAME.json" "$PBF"
          done

    - name: Check if Docker image already exists
      community.docker.docker_image_info:
        name: "{{ docker_image_name }}"
      register: image_info

    - name: Build docker image (only if missing)
      when: image_info.images | length == 0
      community.docker.docker_image:
        name: "{{ docker_image_name }}"
        build:
          path: "{{ build_dir }}"
          platform: linux/arm64
        source: build

    - name: Run conversion container
      community.docker.docker_container:
        name: india-tile-conversion-job
        image: "{{ docker_image_name }}"
        state: started
        auto_remove: yes
        volumes:
          - "{{ pbf_dir }}:/pbf:ro"
          - "{{ shortbread_dir }}:/mbtiles_shortbread"
          - "{{ openmaptiles_dir }}:/mbtiles_openmaptiles"
          - "{{ routing_dir }}:/routing"
        tty: yes
        detach: false